name: Deploy to Production (Using Environments)

on:
  push:
    branches:
      - main

concurrency:
  group: production-deployment
  cancel-in-progress: false

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    # üîë KEY: This line tells GitHub which environment's secrets to use
    # GitHub will pause here and require manual approval (if configured)
    environment:
      name: production
      url: https://glad-labs.com

    env:
      NODE_ENV: production
      LOG_LEVEL: info

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      # ============================================
      # INSTALL PHASE
      # ============================================

      - name: üì¶ Install Node dependencies
        run: npm ci && npm ci --workspaces

      - name: üì¶ Install Poetry
        run: |
          python -m pip install --upgrade pip poetry
          poetry config virtualenvs.create false

      - name: üì¶ Install Python dependencies via Poetry
        run: |
          cd src/cofounder_agent
          poetry install
          cd ../..
        continue-on-error: false

      # ============================================
      # TEST PHASE (Full suite + security before production)
      # ============================================

      - name: üß™ Run all tests
        run: npm run test:ci

      - name: üß™ Run backend tests
        run: npm run test:python

      - name: üèóÔ∏è Build all workspaces
        run: npm run build --if-present

      - name: üîç Run security checks
        run: npm audit --audit-level=moderate
        continue-on-error: true

      # ============================================
      # CMS NOTE: Content managed by Co-Founder Agent
      # ============================================
      # No external CMS required. The Co-Founder Agent
      # handles all content generation and management.

      # ============================================
      # DEPLOYMENT PHASE - CO-FOUNDER AGENT
      # ============================================

      - name: üöÄ Deploy Co-Founder Agent to Railway (Production)
        run: |
          echo "üì§ Deploying Co-Founder Agent to production environment..."
          npm install -g @railway/cli
          railway link --project ${{ secrets.RAILWAY_PROD_PROJECT_ID }}
          railway up --service cofounder-agent-prod
          echo "‚úÖ Co-Founder Agent production deployment completed"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          DATABASE_URL: ${{ secrets.DATABASE_PROD_URL }}
          JWT_SECRET_KEY: ${{ secrets.COFOUNDER_PROD_JWT_SECRET }}
          OPENAI_API_KEY: ${{ secrets.COFOUNDER_PROD_OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.COFOUNDER_PROD_ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.COFOUNDER_PROD_GOOGLE_API_KEY }}
          REDIS_HOST: ${{ secrets.COFOUNDER_PROD_REDIS_HOST }}
          REDIS_PORT: "6379"
          REDIS_PASSWORD: ${{ secrets.COFOUNDER_PROD_REDIS_PASSWORD }}
          SENTRY_DSN: ${{ secrets.COFOUNDER_PROD_SENTRY_DSN }}
          ENVIRONMENT: production

      # ============================================
      # DEPLOYMENT PHASE - PUBLIC SITE
      # ============================================

      - name: üöÄ Deploy Public Site to Vercel (Production)
        run: |
          echo "üì§ Deploying Public Site to production environment..."
          cd web/public-site
          npx vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }}
          cd ../..
          echo "‚úÖ Public Site production deployment completed"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.PUBLIC_SITE_PROD_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          NEXT_PUBLIC_FASTAPI_URL: ${{ secrets.PUBLIC_SITE_PROD_FASTAPI_URL }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.PUBLIC_SITE_PROD_SITE_URL }}
          NEXT_PUBLIC_GA_ID: ${{ secrets.PUBLIC_SITE_PROD_GA_ID }}
          SENTRY_DSN: ${{ secrets.PUBLIC_SITE_PROD_SENTRY_DSN }}

      # ============================================
      # DEPLOYMENT PHASE - OVERSIGHT HUB
      # ============================================

      - name: üöÄ Deploy Oversight Hub to Vercel (Production)
        run: |
          echo "üì§ Deploying Oversight Hub to production environment..."
          cd web/oversight-hub
          npx vercel --prod --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }}
          cd ../..
          echo "‚úÖ Oversight Hub production deployment completed"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.OVERSIGHT_PROD_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          REACT_APP_API_URL: ${{ secrets.OVERSIGHT_PROD_API_URL }}
          REACT_APP_AGENT_URL: ${{ secrets.OVERSIGHT_PROD_AGENT_URL }}
          REACT_APP_AUTH_SECRET: ${{ secrets.OVERSIGHT_PROD_AUTH_SECRET }}
          SENTRY_DSN: ${{ secrets.OVERSIGHT_PROD_SENTRY_DSN }}

      # ============================================
      # POST-DEPLOYMENT VERIFICATION
      # ============================================

      - name: üß™ Smoke Tests
        run: |
          echo "üîç Running smoke tests against production..."

          echo "Waiting for services to stabilize (20 seconds)..."
          sleep 20

          # Get actual deployment URLs from environment or use defaults
          COFOUNDER_URL="${{ secrets.COFOUNDER_PROD_URL }}"
          OVERSIGHT_URL="${{ secrets.OVERSIGHT_PROD_URL }}"

          echo "Testing Co-Founder Agent health..."
          curl -f "${COFOUNDER_URL}/health" || echo "‚ö†Ô∏è Co-Founder Agent health check pending"

          echo "Testing Public Site health..."
          curl -f https://glad-labs.com || echo "‚ö†Ô∏è Public Site health check pending"

          echo "Testing Oversight Hub health..."
          curl -f "${OVERSIGHT_URL}" || echo "‚ö†Ô∏è Oversight Hub health check pending"

          echo "‚úÖ Smoke tests completed"

      - name: üìä Health Checks
        run: |
          echo "üîç Performing production health checks..."

          echo "Checking Co-Founder Agent connectivity..."
          curl -f https://agent-prod.railway.app/health/detailed || echo "‚ö†Ô∏è Agent check pending"

          echo "Checking SSL/TLS certificates..."
          openssl s_client -connect glad-labs.com:443 -servername glad-labs.com < /dev/null | grep -o "Verify return code"

          echo "‚úÖ All systems operational"

      - name: ‚úÖ Verify Production Deployment
        run: |
          echo "üîç Verifying production deployment..."
          echo "‚úÖ All components deployed successfully to production!"
          echo "üåç Production URLs:"
          echo "  - Co-Founder Agent API: ${{ secrets.COFOUNDER_PROD_URL }}/docs"
          echo "  - Public Site: https://glad-labs.com"
          echo "  - Oversight Hub: ${{ secrets.OVERSIGHT_PROD_URL }}"
          echo "üéâ Production environment is live and healthy"

      # ============================================
      # NOTIFICATIONS
      # ============================================

      - name: üì¢ Success Notification
        if: success()
        run: |
          echo "‚úÖ Production deployment completed successfully"
          echo "üéâ All systems are operational"
          echo ""
          echo "üìã Deployment Summary:"
          echo "  ‚úÖ Co-Founder Agent deployed to Railway"
          echo "  ‚úÖ Public Site deployed to Vercel"
          echo "  ‚úÖ Oversight Hub deployed to Vercel"
          echo ""
          echo "üîó Production Links:"
          echo "  - Public Site: https://glad-labs.com"
          echo "  - Co-Founder Agent API: ${{ secrets.COFOUNDER_PROD_URL }}/docs"
          echo "  - Oversight Hub: ${{ secrets.OVERSIGHT_PROD_URL }}"

      - name: üì¢ Failure Notification
        if: failure()
        run: |
          echo "‚ùå Production deployment failed"
          echo "üö® IMMEDIATE ACTION REQUIRED"
          echo ""
          echo "üìã Troubleshooting Steps:"
          echo "  1. Check GitHub Actions logs for error details"
          echo "  2. Verify all secrets are correctly configured"
          echo "  3. Check Railway and Vercel dashboards for deployment status"
          echo "  4. Review recent code changes for breaking issues"
          echo "  5. Consider rolling back to previous stable version"
          echo ""
          echo "üîó Debug Resources:"
          echo "  - GitHub Actions: https://github.com/mattg-stack/glad-labs-website/actions"
          echo "  - Railway Dashboard: https://railway.app"
          echo "  - Vercel Dashboard: https://vercel.com"
          exit 1
