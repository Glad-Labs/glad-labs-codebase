name: Deploy to Staging (Using Environments)

on:
  push:
    branches:
      - staging

concurrency:
  group: staging-deployment
  cancel-in-progress: false

jobs:
  test-and-deploy:
    runs-on: ubuntu-latest

    # üîë KEY: This line tells GitHub which environment's secrets to use
    environment: staging

    env:
      NODE_ENV: staging
      LOG_LEVEL: debug

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: üêç Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      # ============================================
      # INSTALL PHASE
      # ============================================

      - name: üì¶ Install Python dependencies (CI/CD - Optimized)
        run: |
          python -m pip install --upgrade pip
          pip install --no-cache-dir -r scripts/requirements-ci.txt
        continue-on-error: false

      - name: üóëÔ∏è Clean pip cache
        run: pip cache purge

      - name: üì¶ Install backend-specific requirements
        run: |
          pip install --no-cache-dir -r src/cofounder_agent/requirements.txt
        continue-on-error: false

      - name: üóëÔ∏è Clean pip cache again
        run: pip cache purge

      # ============================================
      # TEST PHASE (Full suite before staging)
      # ============================================

      - name: üß™ Run tests
        run: npm run test:ci
        continue-on-error: true

      - name: üß™ Run backend tests
        run: npm run test:python
        continue-on-error: true

      - name: üèóÔ∏è Build all workspaces
        run: npm run build --if-present

      # ============================================
      # NOTE: Strapi CMS deployment removed (not in use)
      # ============================================
      # Strapi CMS deployment is not configured for this project
      # The Co-Founder Agent handles all content management

      # ============================================
      # DEPLOYMENT PHASE - CO-FOUNDER AGENT
      # ============================================

      - name: üöÄ Deploy Co-Founder Agent to Railway (Staging)
        run: |
          echo "üì§ Deploying Co-Founder Agent to staging environment..."
          cd src/cofounder_agent
          npx railway up
          cd ../..
          echo "‚úÖ Co-Founder Agent staging deployment completed"
        env:
          RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
          RAILWAY_PROJECT_ID: ${{ secrets.RAILWAY_STAGING_PROJECT_ID }}
          RAILWAY_SERVICE_ID: cofounder-agent-staging
          DATABASE_URL: ${{ secrets.DATABASE_STAGING_URL }}
          JWT_SECRET_KEY: ${{ secrets.COFOUNDER_STAGING_JWT_SECRET }}
          OPENAI_API_KEY: ${{ secrets.COFOUNDER_STAGING_OPENAI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.COFOUNDER_STAGING_ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.COFOUNDER_STAGING_GOOGLE_API_KEY }}
          REDIS_HOST: ${{ secrets.COFOUNDER_STAGING_REDIS_HOST }}
          REDIS_PORT: "6379"
          REDIS_PASSWORD: ${{ secrets.COFOUNDER_STAGING_REDIS_PASSWORD }}
          SENTRY_DSN: ${{ secrets.COFOUNDER_STAGING_SENTRY_DSN }}
          ENVIRONMENT: staging

      # ============================================
      # DEPLOYMENT PHASE - PUBLIC SITE
      # ============================================

      - name: üöÄ Deploy Public Site to Vercel (Staging)
        run: |
          echo "üì§ Deploying Public Site to staging environment..."
          cd web/public-site
          npx vercel --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }}
          cd ../..
          echo "‚úÖ Public Site staging deployment completed"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.PUBLIC_SITE_STAGING_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          NEXT_PUBLIC_FASTAPI_URL: ${{ secrets.PUBLIC_SITE_STAGING_FASTAPI_URL }}
          NEXT_PUBLIC_SITE_URL: ${{ secrets.PUBLIC_SITE_STAGING_SITE_URL }}
          NEXT_PUBLIC_GA_ID: ${{ secrets.PUBLIC_SITE_STAGING_GA_ID }}
          SENTRY_DSN: ${{ secrets.PUBLIC_SITE_STAGING_SENTRY_DSN }}

      # ============================================
      # DEPLOYMENT PHASE - OVERSIGHT HUB
      # ============================================

      - name: üöÄ Deploy Oversight Hub to Vercel (Staging)
        run: |
          echo "üì§ Deploying Oversight Hub to staging environment..."
          cd web/oversight-hub
          npx vercel --token=${{ secrets.VERCEL_TOKEN }} --scope=${{ secrets.VERCEL_ORG_ID }}
          cd ../..
          echo "‚úÖ Oversight Hub staging deployment completed"
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_PROJECT_ID: ${{ secrets.OVERSIGHT_STAGING_PROJECT_ID }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          REACT_APP_API_URL: ${{ secrets.OVERSIGHT_STAGING_API_URL }}
          REACT_APP_AGENT_URL: ${{ secrets.OVERSIGHT_STAGING_AGENT_URL }}
          REACT_APP_AUTH_SECRET: ${{ secrets.OVERSIGHT_STAGING_AUTH_SECRET }}
          SENTRY_DSN: ${{ secrets.OVERSIGHT_STAGING_SENTRY_DSN }}

      # ============================================
      # VERIFICATION PHASE
      # ============================================

      - name: ‚úÖ Verify Staging Deployment
        run: |
          echo "üîç Verifying staging deployment..."
          echo "Waiting for services to stabilize (15 seconds)..."
          sleep 15

          echo "Testing Co-Founder Agent..."
          curl -f https://agent-staging.railway.app/docs || echo "‚ö†Ô∏è Agent health check pending"

          echo "Testing Public Site..."
          curl -f https://public-site-staging.vercel.app || echo "‚ö†Ô∏è Public Site health check pending"

          echo "Testing Oversight Hub..."
          curl -f https://oversight-staging.vercel.app || echo "‚ö†Ô∏è Oversight Hub health check pending"

          echo "‚úÖ All components deployed successfully to staging!"
          echo "üìä Staging environment is now live"

      - name: üì¢ Notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ Staging deployment completed successfully"
            echo "üìä All services are operational"
            echo "üåç Staging URLs:"
            echo "  - Agent API: https://agent-staging.railway.app/docs"
            echo "  - Public Site: https://public-site-staging.vercel.app"
            echo "  - Oversight Hub: https://oversight-staging.vercel.app"
          else
            echo "‚ùå Staging deployment failed"
            echo "üîç Check GitHub Actions logs for details"
          fi
