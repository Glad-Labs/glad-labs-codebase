# Hybrid Package Manager Strategy: npm + yarn

## Overview

GLAD Labs uses a **hybrid package manager strategy** for optimal stability and consistency:

- **Local Development:** npm (entire monorepo)
- **Railway Strapi:** yarn (proven stable on Railway)
- **Frontend Deployments:** npm (Vercel/root workspaces)

## Why This Approach

### Problem Solved

When we tried to use npm for Strapi on Railway:

1. Build succeeded locally with npm
2. Railway deployment had cookie security issues: "Cannot send secure cookie over unencrypted connection"
3. Yarn-based Strapi deployments worked perfectly on Railway before

### Solution

Use yarn **only** for Strapi on Railway while keeping npm everywhere else. This combines:

- ✅ **Local development consistency** - Single npm command for all services
- ✅ **Production stability** - Yarn for Strapi (proven on Railway)
- ✅ **Minimal complexity** - Only 2 package managers, one per service

## Implementation

### Root Level (npm)

**File:** `package.json`

- Uses: npm@9.0.0
- Manages: Oversight Hub, Public Site, Python services
- Lockfile: `package-lock.json`

### Strapi Level (yarn)

**File:** `cms/strapi-main/package.json`

```json
{
  "engines": {
    "node": ">=18.0.0 <=22.x.x",
    "yarn": ">=1.22.0"
  },
  "packageManager": "yarn@1.22.22"
}
```

- Uses: yarn@1.22.22
- Lockfile: `yarn.lock` (generated by Railway)
- Why: Strapi v5 + PostgreSQL combination is stable with yarn on Railway

## Local Development Workflow

### Install Dependencies

```bash
# All services use npm locally (including Strapi)
npm install

# This installs dependencies for:
# - Root workspace
# - web/public-site
# - web/oversight-hub
# - cms/strapi-main (uses npm locally for development)
```

### Start All Services

```bash
npm run dev

# Launches:
# - Strapi (localhost:1337)
# - Public Site (localhost:3000)
# - Oversight Hub (localhost:3001)
# - Co-founder Agent (localhost:8000)
```

### Add Dependencies to Strapi (Locally)

```bash
cd cms/strapi-main
npm install some-package
```

## Railway Deployment Workflow

### Strapi Deployment (Railway)

1. **Detect packageManager:**
   - Railway reads `cms/strapi-main/package.json`
   - Sees: `"packageManager": "yarn@1.22.22"`
   - **Automatically uses yarn** instead of npm

2. **Install with yarn:**
   - Railway runs: `yarn install`
   - Uses `yarn.lock` (auto-generated by yarn)
   - Respects dependency resolution yarn uses

3. **Build & Start:**
   - Runs: `yarn build` and `yarn start`
   - Strapi starts with stable yarn-based dependencies

### Public Site Deployment (Vercel)

1. **Detect packageManager:**
   - Vercel reads root `package.json`
   - Sees: `"packageManager": "npm@9.0.0"`
   - **Uses npm**

2. **Install with npm:**
   - Runs: `npm install`
   - Uses `package-lock.json`

## Key Files

| File                           | Purpose                | Package Manager | Environment          |
| ------------------------------ | ---------------------- | --------------- | -------------------- |
| `package.json` (root)          | Monorepo orchestration | npm             | Local + Vercel       |
| `package-lock.json` (root)     | npm lock file          | npm             | Version control      |
| `cms/strapi-main/package.json` | Strapi config          | yarn            | Local + Railway      |
| `cms/strapi-main/yarn.lock`    | yarn lock file         | yarn            | Generated by Railway |

## Troubleshooting

### "Cannot send secure cookie over unencrypted connection"

**This error only appears when using npm for Strapi on Railway.** Solution:

- Ensure `cms/strapi-main/package.json` has `"packageManager": "yarn@1.22.22"`
- Railway will automatically detect and use yarn
- Issue resolves on next deployment

### Dependencies Out of Sync

If Strapi dependencies differ between local and Railway:

```bash
# Local: Regenerate lock file with npm
cd cms/strapi-main
rm package-lock.json
npm install
```

Railway will use yarn instead and generate `yarn.lock`.

### Mix-up Between npm and yarn Commands

**In local development:**

- Use `npm` for everything (root + Strapi)
- Never use `yarn` locally (can cause confusion)

**On Railway:**

- Strapi automatically uses yarn (detected from packageManager)
- You don't need to do anything

## Migration Path (Why We Changed)

### Before (Failed)

```json
// cms/strapi-main/package.json
"packageManager": "npm@9.0.0"  // ❌ Caused cookie issues on Railway
```

### After (Works)

```json
// cms/strapi-main/package.json
"packageManager": "yarn@1.22.22"  // ✅ Railway uses yarn automatically
```

## Verification

After deploying to Railway, verify yarn is being used:

1. **Check Railway logs:**

   ```
   yarn install v1.22.22
   [4/4] Building fresh packages...
   Done in 1.23s
   ```

2. **Try logging in to Strapi admin:**

   ```
   https://glad-labs-website-production.up.railway.app/admin
   ```

   Should NOT see "Cannot send secure cookie" error

3. **Check environment in Railway:**
   - Environment: `production`
   - Node version: `18.x`
   - Package Manager: yarn

## Best Practices

1. ✅ **Always use `npm` locally** - Entire monorepo
2. ✅ **Never commit `yarn.lock`** - Railway generates it
3. ✅ **Keep `package-lock.json`** - Root monorepo uses npm
4. ✅ **Monitor Railway logs** - Confirm yarn is detected
5. ✅ **Test production flow** - After each Strapi update

## Summary

This hybrid strategy gives us:

- Local development simplicity (one package manager)
- Production stability (proven Strapi + yarn combination)
- Minimal maintenance overhead
- Clear separation of concerns
