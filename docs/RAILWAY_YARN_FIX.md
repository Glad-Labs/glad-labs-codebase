# Railway Yarn Configuration Fix

**Date:** October 22, 2025  
**Issue:** Strapi deployment on Railway was using npm instead of yarn  
**Status:** ✅ Fixed

## Problem

Even though `cms/strapi-main/package.json` specified `"packageManager": "yarn@1.22.22"`, Railway was still using npm to build and run Strapi. This caused:

1. TypeScript config files (.ts) not being compiled properly
2. Error: "Config file not loaded, extension must be one of .js,.json): admin.ts"
3. Cookie security errors due to misconfiguration
4. Inconsistent behavior from the previous working yarn-based deployment

## Root Cause

Railway Railpack (the build system) wasn't detecting the packageManager field in the workspace-level `package.json` when deployed as part of a monorepo. The root `package.json` was overriding the workspace configuration.

## Solution

Added explicit Railway configuration files to force yarn usage:

### Files Created/Modified

#### 1. **`cms/strapi-main/Procfile`**
```
web: yarn start
```
- Explicitly tells Railway to start Strapi using yarn
- Overrides default `npm start` behavior

#### 2. **`cms/strapi-main/.nvmrc`**
```
20.19.5
```
- Specifies Node.js version 20.19.5
- Ensures consistency with package.json `engines` requirement

#### 3. **`cms/strapi-main/.yarnrc.yml`**
```yaml
nodeLinker: node-modules
```
- Configures yarn to use node_modules (compatible with existing setup)
- Ensures proper dependency installation

#### 4. **`cms/strapi-main/yarn.lock`** (Initial)
```
# THIS IS A GENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
# yarn lockfile v1
```
- Signals to Railway that this project uses yarn
- Railway will regenerate this on first install with yarn
- Prevents npm from trying to use its own lockfile

#### 5. **`cms/strapi-main/railway.json`** (Updated)
```json
{
    "$schema": "https://backboard.railway.app/railway.schema.json",
    "build": {
        "builder": "RAILPACK"
    },
    "deploy": {
        "restartPolicyMaxRetries": 5
    }
}
```
- Ensures Railpack builder is used
- Adds retry policy for reliability

## How It Works

When Railway detects changes on the `dev` branch (or your deployment branch):

1. **Detects Procfile** → Uses yarn start instead of npm start
2. **Reads .nvmrc** → Uses Node 20.19.5
3. **Sees yarn.lock** → Recognizes this as a yarn project
4. **Detects .yarnrc.yml** → Applies yarn configuration
5. **Reads package.json** → Sees `"packageManager": "yarn@1.22.22"`
6. **Installs dependencies with yarn** → Consistent with local development
7. **Runs `yarn start`** → Strapi starts successfully

## Testing

After this fix is deployed to Railway:

1. Check logs: "Using yarn package manager" should appear
2. No TypeScript compilation errors
3. Admin panel cookie security should work (no "Cannot send secure cookie" errors)
4. Strapi starts successfully on Node 20

## Local Development

**No changes to local workflow!** You still:

```bash
cd cms/strapi-main
npm install  # Local npm still works for development
npm run dev
```

Or from root:

```bash
npm run dev  # All services start with npm locally
```

## Future Maintenance

When updating Strapi dependencies:

1. **Locally:** Continue using npm
   ```bash
   cd cms/strapi-main
   npm install @strapi/plugin-seo@latest
   ```

2. **Yarn.lock will be auto-generated** on Railway's next build

## Reference

- Railway Railpack: https://railway.app/docs/build-systems/railpack
- Yarn Configuration: https://yarnpkg.com/configuration
- Procfile Documentation: https://devcenter.heroku.com/articles/procfile

